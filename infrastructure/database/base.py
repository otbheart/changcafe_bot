# infrastructure/database/base.py
"""
üóÑÔ∏è DATABASE - Base –∏ Engine

–≠—Ç–æ—Ç —Ñ–∞–π–ª —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å PostgreSQL
–∏ —Å–æ–∑–¥–∞–µ—Ç "—Å–µ—Å—Å–∏–∏" (–æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î).

async = –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ) –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
"""

from sqlalchemy.ext.asyncio import (
    create_async_engine,     
    async_sessionmaker,      
    AsyncSession             
)
from sqlalchemy.orm import declarative_base

from config.settings import config

# ==========================================
# BASE –¥–ª—è –º–æ–¥–µ–ª–µ–π (–ë–ï–ó —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞!)
# ==========================================

Base = declarative_base()

# ==========================================
# –°–û–ó–î–ê–ï–ú –ê–°–ò–ù–•–†–û–ù–ù–´–ô ENGINE (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î)
# ==========================================

engine = create_async_engine(
    config.async_database_url,
    echo=config.debug,    
    pool_size=20,         
    max_overflow=10,      
    pool_pre_ping=True    
)

# ==========================================
# –°–û–ó–î–ê–ï–ú SESSION MAKER (—Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π)
# ==========================================

async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,      
    expire_on_commit=False,   
    autoflush=False,          
    autocommit=False          
)

# ==========================================
# –§–£–ù–ö–¶–ò–Ø: Dependency Injection –¥–ª—è FastAPI/aiogram
# ==========================================

async def get_db_session() -> AsyncSession:
    """
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
    
    –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ —Å–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
    """
    
    async with async_session_maker() as session:
        yield session

# ==========================================
# –§–£–ù–ö–¶–ò–Ø: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü)
# ==========================================

async def init_db():
    """
    –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    from infrastructure.database.models import Order
    
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

# ==========================================
# –§–£–ù–ö–¶–ò–Ø: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
# ==========================================

async def close_db():
    """
    –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    
    await engine.dispose()
