# app/bot/utils/phone.py
"""
Утилиты для работы с номерами телефонов.

Проблема: пользователи вводят номера в разных форматах:
- 79991234567 (без плюса)
- +79991234567 (с плюсом)
- 89991234567 (со старым кодом России)
- +7 999 123 45 67 (с пробелами)

Наша функция normalize_phone приводит все к единому формату: +79991234567
"""

import re


def normalize_phone(phone: str) -> str:
    """
    Приводит номер телефона к единому формату: +7XXXXXXXXXX
    
    Примеры:
        normalize_phone("79991234567") → "+79991234567"
        normalize_phone("+79991234567") → "+79991234567"
        normalize_phone("89991234567") → "+79991234567" (заменяет 8 на 7)
        normalize_phone("+7 999 123 45 67") → "+79991234567" (убирает пробелы)
    
    Алгоритм:
    1. Оставляем только цифры и плюс
    2. Если начинается с 8, заменяем на 7
    3. Добавляем плюс в начало если его нет
    """
    
    # Шаг 1: убираем всё кроме цифр и плюса
    cleaned = re.sub(r'[^\d+]', '', phone)
    
    # re.sub = регулярное выражение "заменить"
    
    # r'[^\d+]' = "всё что НЕ цифра и НЕ плюс"
    
    # '' = заменяем на пусто
    
    
    # Шаг 2: если начинается с 8, заменяем на 7 (старый формат России)
    
    if cleaned.startswith('8'):
        cleaned = '7' + cleaned[1:]  
        # cleaned[1:] = всё кроме первого символа
    
    
    # Шаг 3: добавляем плюс в начало
    
    if not cleaned.startswith('+'):
        cleaned = '+' + cleaned
    
    return cleaned


def phones_match(phone1: str, phone2: str) -> bool:
    """
    Проверяет, совпадают ли два номера телефона (после нормализации).
    
    Пример:
        phones_match("79991234567", "+79991234567") → True
        phones_match("89991234567", "+79991234567") → True
        phones_match("+79991234567", "+79991234567") → True
        phones_match("+79991234567", "+79991111111") → False
    
    Используем для проверки: номер в форме Tilda совпадает с номером в Telegram?
    """
    
    try:
        
        # Нормализуем оба номера
        norm_phone1 = normalize_phone(phone1)
        norm_phone2 = normalize_phone(phone2)
        
        # Сравниваем нормализованные версии
        
        return norm_phone1 == norm_phone2
    
    except:
        
        # Если ошибка (например, невалидный номер), возвращаем False
        
        return False

