# app/bot/utils/text.py
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤.

–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Ç–µ–∫—Å—Ç—ã –≤–µ–∑–¥–µ –≤ –∫–æ–¥–µ,
—Å–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –≥–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã.

–≠—Ç–æ —É–¥–æ–±–Ω–æ –ø–æ—Ç–æ–º –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç, –º–µ–Ω—è–µ–º –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
2. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–æ –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É
3. –õ–µ–≥—á–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏
"""

from infrastructure.database.models import Order


def format_items(items: list) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    
    –ù–∞ –≤—Ö–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç JSON:
    [
        {"title": "–ü–∏—Ü—Ü–∞ ", "price": 690, "quantity": 1},
        {"title": "–ö–æ–ª–∞ ", "price": 500, "quantity": 1}
    ]
    
    –ù–∞ –≤—ã—Ö–æ–¥–µ –¥–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç:
    ‚Ä¢ –ü–∏—Ü—Ü–∞ x1 ‚Äî 690‚ÇΩ
    ‚Ä¢ –ö–æ–ª–∞ x1 ‚Äî 500‚ÇΩ
    """
    
    if not items:
        return "–¢–æ–≤–∞—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã"
    
    lines = []
    
    for i, item in enumerate(items, 1):  
        # enumerate(items, 1) = –Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 1
        title = item.get("title", "–¢–æ–≤–∞—Ä")  
        # item.get = –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        qty = item.get("quantity", 1)
        price = item.get("price", 0)
        line = f"‚Ä¢ {title} x{qty} ‚Äî {price}‚ÇΩ"
        lines.append(line)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º
    
    return "\n".join(lines)


def order_card_text(order: Order, for_operator: bool = False) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞.
    
    –ù–∞ –≤—Ö–æ–¥: –æ–±—ä–µ–∫—Ç Order
    –ù–∞ –≤—ã—Ö–æ–¥: –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    
    –ü—Ä–∏–º–µ—Ä –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:
        üõí –ó–∞–∫–∞–∑ 2067628905
        
        üë§ –ò–≤–∞–Ω
        üìû +79991234567
        üìç —É–ª. –õ–µ–Ω–∏–Ω–∞, 10
        
        üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
        ‚Ä¢ –ü–∏—Ü—Ü–∞ x1 ‚Äî 690‚ÇΩ
        ‚Ä¢ –ö–æ–ª–∞ x1 ‚Äî 500‚ÇΩ
        
        üí∞ –°—É–º–º–∞: 1190‚ÇΩ
    
    –ü—Ä–∏–º–µ—Ä –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏):
        (–≤—Å—ë —Ç–æ –∂–µ —Å–∞–º–æ–µ +)
        
        üìä –°—Ç–∞—Ç—É—Å: waiting_operator
        üì± –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: +79991234567
    """
    items_text = format_items(order.items)
    
    # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–¥–ª—è –≤—Å–µ—Ö)
    base_text = (
        f"üõí –ó–∞–∫–∞–∑ {order.external_order_id}\n\n"
        f"üë§ {order.tilda_name}\n"
        f"üìû {order.tilda_phone}\n"
        f"üìç {order.address}\n\n"
        f"üõçÔ∏è –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n{items_text}\n\n"
        f"üí∞ –°—É–º–º–∞: {order.base_amount}‚ÇΩ"
    )
    
    # –ï—Å–ª–∏ —ç—Ç–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    
    if for_operator:
        base_text += f"\n\nüìä –°—Ç–∞—Ç—É—Å: {order.status.value}"
        
        if order.confirmed_phone:
            base_text += f"\nüì± –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: {order.confirmed_phone}"
    
    return base_text


def operator_message_template(order: Order) -> str:
    """
    –®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É.
    
    –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É.
    
    –ü—Ä–∏–º–µ—Ä:
        –î–æ–±—Ä—ã–π –¥–µ–Ω—å! –î–æ—Å—Ç–∞–≤–∫–∞ –ß–∞–Ω–≥ üçï
        
        –û—Ç –≤–∞—Å –ø–æ—Å—Ç—É–ø–∏–ª –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É 1190‚ÇΩ
        –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º –Ø–Ω–¥–µ–∫—Å Go –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞: 300‚ÇΩ
        
        –ò—Ç–æ–≥–æ: 1490‚ÇΩ
        
        –ï—Å–ª–∏ –≤–∞–º –≤—Å—ë –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚úÖ
    """
    delivery_cost = order.delivery_cost or 0   
    # –ï—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞ –µ—â—ë –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞, 0
    total = order.base_amount + delivery_cost
    
    return (
        f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –î–æ—Å—Ç–∞–≤–∫–∞ –ß–∞–Ω–≥ üçï\n\n"
        f"–û—Ç –≤–∞—Å –ø–æ—Å—Ç—É–ø–∏–ª –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É {order.base_amount}‚ÇΩ\n"
        f"–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º –Ø–Ω–¥–µ–∫—Å Go –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞: {delivery_cost}‚ÇΩ\n\n"
        f"–ò—Ç–æ–≥–æ: {total}‚ÇΩ\n\n"
        f"–ï—Å–ª–∏ –≤–∞–º –≤—Å—ë –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚úÖ"
    )

